# Cosmos DB for PostgreSQL (Citus) の概要
Cosmos DB for PostgreSQL(Citus)は、クラウドで可用性の高いPostgreSQLデータベースを実行、管理、および拡張するために使用するマネージドサービスです。この手順では、Azureポータルを使用してCosmos DB for PostgreSQL(Citus)のサーバーグループを作成する方法について説明します。分散データ（ノード間でのシャーディングテーブル、サンプルデータの読み込み、複数のノードで実行されるクエリの実行）について説明します。

# Cosmos DB for PostgreSQL (Citus) の概要
Cosmos DB for PostgreSQL(Citus) は、スケールアウトするために構築された安心なPostgreSQLです。複数のマシンのクラスターに、データ、およびクエリを配布（シャード）します。Cosmos DB for PostgreSQL (Citus)は、（フォークではなく）拡張機能として、新しいPostgreSQLリリースをサポートしており、既存のPostgreSQLツールとの互換性を維持しながら、ユーザーが新機能の恩恵を受けられるようにします。既存のワークロードにおけるパフォーマンスとスケーラビリティの2つの主要な問題を解決します。通常のPostgreSQLと同様に、Cosmos DB for PostgreSQL (Citus)もデータベースを管理します。高可用性、バックアップ、監視、アラート、その他の追加機能を提供し、これらはPaaS（サービスとしてのプラットフォーム）の一部として提供されます。

# Cosmos DB for PostgreSQL (Citus)のアーキテクチャ:
クラスタには、コーディネーターと呼ばれる1つの特殊ノードが必ずあります（他のノードはワーカーと呼ばれます）。アプリケーションは、コーディネーターにクエリを送信し、コーディネーターは関連付けられたワーカーにクエリを中継し、結果を蓄積します。
各クエリについて、コーディネーターは、それを単一のワーカーにルーティングするか、必要なデータが単一あるいは複数のワーカーに存在するかに応じて、クエリをいくつかに並列化します。Cosmos DB for PostgreSQL (Citus)が複数のワーカーにクエリを分散する方法に関するシナリオを次に示します。

<IMG>

# Cosmos DB for PostgreSQL (Citus) の概要
まず、提供された資格情報を使用してAzureポータルにログインする必要があります。

## Azureポータルへのサイン・イン
1. Azure Portalに既にログインしている場合は、次のページにスキップします。このウィンドウの右下にあるNextをクリックします。
2. ブラウザで `https://portal.azure.com` を開き、ブラウザのウインドウを最大化します。
3. *[アカウントを選択する]* というダイアログが表示されたら、*[別のアカウントを使用する]* を選択します。
4. *[サインイン]* ダイアログの、*[メール、電話、Skype]* フィールドに
`userxxxxxx@cloudplatimmersionlabs.onmicrosoft.com` を入力し *[次へ]* をクリックします。
5. *[パスワード]* フィールドに`xxxxxxxx`を入力します。
6. *[サインイン]* をクリックします。
7. *[サインインの状態を維持しますか?]* とタイトルがついた、[いいえ]と[はい]ボタンがあるポップアップが表示されるかもしれません。[いいえ]を選択します。
8. Welcome to Microsoft AzureとタイトルがついたStart TourとMaybe Laterボタンがあるポップアップが表示されるかもしれません。Maybe Laterを選択します。

# Cosmos DB for PostgreSQL (Citus) を使い始める
これらの手順では、Azureポータルを使用してCosmos DB for PostgreSQL (Citus) サーバーグループを作成する方法について説明します。クラスターの規模によって作成に必要な時間は変わりますが、このハンズオンで作成するサーバーグループの規模であれば、通常約10分かかります。以下の手順では、プロセスを通じてこれがいかにシンプルで簡単であるかが分かります。

# Cosmos DB for PostgreSQL (Citus)を作成する
次の手順に従って、Azureポータルを使用してCosmos DB for PostgreSQL (Citus) サーバーグループを作成するプロセスを理解します。
1. Azureポータルの左上にある *[+リソースの作成]* をクリックします。
2. Azure Marketplaceの[リソースの作成]ページで[データベース]を選択し、[人気のAzureサービス]ページで[Cosmos DB]を選択します。
3. [PostgreSQLデプロイオプションのAzureデータベースの選択]ページで、[Hyperscale (Citus) サーバーグループ]の下の[作成]ボタンをクリックします。
4. 以下の情報を[Hyperscale (Citus)サーバーグループ]の基本タブに入力します。
-	サブスクリプション: あなたのセッションのサブスクリプションがデフォルトになっています。
-	リソースグループ: [新規作成]をクリックし、任意のリソースグループ名（例: `citushandsonlab_rg`）を入力します。
-	サーバーグループ名: 任意のサーバーグループ名（例: `citushandsonlab`）を入力します。
-	場所: [Japan East]あるいは任意のAzureリージョンを選択します。
-	コンピューティングとストレージ: [サーバーグループの構成]をクリックし、ハンズオンのトレーナーの指示に従ってください。通常は[階層]から[Basic]あるいは[Standard]を選択し、コーディネータとワーカーの設定はそのままにして[保存]をクリックします。
-	管理者ユーザー名: 現時点では`citus`という値がデフォルトで変更することは出来ません。
-	パスワード: `xxxxxxxx`を入力し、[パスワードの確認]にも同じパスワードを入力します。

> 注: Cosmos DB for PostgreSQL (Citus) デプロイを作成する場合、最大20のワーカーノードを水平方向にスケーリングできます。20以上のノードが必要な場合は、サポートチケットを作成するだけで、有効になります。コーディネーターと同様に、すべてのワーカー（コア、ストレージ）をスケールアップできますが、ストレージはスケールダウンが出来ません。RAMは、コア数とサーバーの種類（コーディネーターまたはワーカー）で決まります。
5. [確認および作成]をクリックするとサマリーが表示されます。サマリーを確認後、[作成]ボタンをクリックするとデプロイが開始されます。
> 注: [作成]ボタンをクリックするとデプロイが開始され、デプロイメントを監視するページにリダイレクトされます。

6. Azureポータルの左上にある[ホーム]をクリックします。
7. [Azureサービス]の下にある[Cosmos DB]をクリックします。
8. 作成時に入力したサーバーグループ名（例: `citushandsonlab`）をクリックします。
Cosmos DB for PostgreSQL (Citus)サーバーグループを管理するAzure Portalの概要タブが表示されます。この概要タブの右上には、サーバーグループへの接続に使用するコーディネーター名（例: `c.citushandsonlab.postgres.database.azure.com`）が表示されます。
9. 左にある[接続文字列]をクリックし、接続文字列を表示して確認します。
10. 左にある[コンピューティングとストレージ]をクリックし、サーバーグループを構成する各ノードのサイズを表示します。

# Cosmos DB for PostgreSQL (Citus) の使用を開始する
Azureポータルのクラウドシェルを使用してCosmos DB for PostgreSQL (Citus)サーバーグループに接続するには、ストレージアカウントを作成する必要があります。ストレージアカウントを使用すると、クラウドシェルに関連付けられたファイルを保存できるため、スクリプトの実行、データファイルのダウンロード、Azureリソースの管理など、さまざまなAzureポータルアクティビティで使用できます。

# クラウドシェルを作成する
1. ポータルのバナーでクラウドシェルのアイコンをクリックします。 
2. [ストレージがマウントされていません]の画面で、[詳細設定の表示]をクリックします。
3. サブスクリプションを選択します。
4. リージョンに[東日本]あるいは任意のリージョンを選択します。
5. リソースグループは既存のCosmos DB for PostgreSQL (Citus)のサーバーグループを作成したグループあるいは任意のグループを使うようにしてください。
6. ストレージアカウントには、[新規作成]を選択し、任意のストレージアカウント名（例: `citushandsonlab`）をペーストします。
7. ファイルシェアには、[新規作成]を選択し、任意の共有ファイル名（例: `citushandsonlab`）を入力してください。
8. [作成]をクリックします。

> 注: クラウドシェルを作成・開始するのに1分程度を要します。

9. 次の手順でファイアウォールを構成するには、クラウドシェルのクライアントIPアドレスが必要です。コマンドプロンプトで次のコマンドを入力し、returnキーを押してから、クラウドシェルのIPアドレスをコピーまたはメモします。

```
curl -s https://ifconfig.co
```

> 注: bashコンソールでペーストするには右クリック後にpasteを選択します。

# Hyperscale (Citus) の利用を開始する
Azure Database for PostgreSQL Hyperscale (Citus) は、サーバーレベルでファイアウォールを使用します。既定では、ファイアウォールはすべての外部アプリケーションとツールがコーディネーターノードおよび内部のデータベースに接続するのを防ぎます。特定のIPアドレス範囲からの接続を許可するルールを追加する必要があります。

# サーバーレベルのファイアウォールのルールを設定する
□1. Hyperscaleサーバーグループの[ネットワーク]を選択します。
□2. [ネットワーク接続]ペインの[パブリックアクセス]内で、クラウドシェルで確認した[IPアドレス]を[開始IPアドレス]と[終了IPアドレス]に入力します。
□3. [ファイアウォール規則名]に[CloudShell]と入力します。
□4. ペインの左上にある[保存]をクリックします。

> 注: Hyperscale (Citus) サーバーは5432/TCPポートを介して通信します。企業ネットワーク内から接続しようとしている場合、5432/TCPポートへの送信トラフィックは、ネットワークのファイアウォールで許可されない場合があります。その場合は、IT部門が5432/TCPポートへの通信を許可しない限り、Hyperscale (Citus) サーバーに接続できません。

# Azure Database for PostgreSQL Hyperscale (Citus)に接続する
Hyperscale (Citus)を作成すると、citusという名前の既定のデータベースが作成されます。データベースサーバーに接続するには、接続文字列と管理者パスワードが必要です。最初の接続には最大2分かかる場合があります。何らかの理由でシェルがタイムアウトして再起動した場合は、curl -s https://ifconfig.coコマンドをもう一度実行し、ファイアウォールが新しいIPアドレスで更新されていることを確認する必要があります。

# `psql`でデータベースに接続する
□1. クラウドシェルの右上にある最大化ボックスをクリックして全画面にします。
□2. Bashプロンプトで、Psqlユーティリティを用いてAzure Database for PostgreSQLに接続します。最初の接続には最大2分かかる場合があります。以下のコマンドをコピー＆ペーストして[enter]を押します。

```
psql "host=c.citushandsonlab.postgres.database.azure.com port=5432 dbname=citus user=citus password='xxxxxxxx' sslmode=require"
```

テーブルを作成しスケールアウトする
Psqlを使用してHyperscale (Citus) コーディネーターノードに接続すると、いくつかの基本的なタスクを完了できます。
この経験では、主に分散テーブルとそれらに慣れることに焦点を当てます。これから作業するデータモデルは単純です：GitHubのユーザーデータとイベントデータ。イベントには、フォークの作成、組織に関連するgitコミットなどが含まれます。Psql経由で接続したら、テーブルを作成してみましょう。
□3. Psqlコンソールで以下をコピー＆ペーストしてテーブルを作成します。

```
CREATE TABLE github_events(
event_id bigint,
event_type text,
event_public boolean,
repo_id bigint,
payload jsonb,
repo jsonb,
user_id bigint,
org jsonb,
created_at timestamp
);
CREATE TABLE github_users(
user_id bigint,
url text,
login text,
avatar_url text,
gravatar_id text,
display_login text
);
```

github_eventsテーブルのペイロードフィールドには、JSONBデータ型があります。JSONBはPostgreSQLのバイナリ形式のJSONデータ型です。JSONデータ型を使用すると、柔軟なスキーマを1つの列に簡単に格納できます。PostgreSQLは、この型にGINインデックス（Generalized Inverted Index、汎用転置インデックス）を作成し、その中のすべてのキーと値にインデックスを付けることができます。インデックスを使用すると、さまざまな条件でペイロードを高速かつ簡単に照会できます。データを読み込む前に、いくつかのインデックスを作成してみましょう。

4. Psqlコンソールで以下をコピー＆ペーストしてインデックスを作成します。
```
CREATE INDEX event_type_index ON github_events (event_type);
CREATE INDEX payload_index ON github_events USING GIN (payload jsonb_path_ops);
```

次に、コーディネーターノード上のPostgreSQLテーブルを指定し、Hyperscale (Citus) にワーカー全体でシャードするように伝えます。そのために、それをシャードするキーを指定する各テーブルに対してクエリを実行します。この例では、user_idのイベントテーブルとユーザーテーブルの両方をシャードします。

5. Psqlコンソールで以下をコピー＆ペーストします。
```
SELECT create_distributed_table('github_events', 'user_id');
SELECT create_distributed_table('github_users', 'user_id');
```
このコマンドはテーブルごとに、ワーカーノードにシャードを作成します。各シャードは、一連のユーザーを保持する単純なpostgresqlテーブルです（user_idでシャード化したので）。また、コーディネーターノードにメタデータを作成して、分散テーブルのセットとワーカーノードのシャードの局所性を追跡します。user_idで両方のテーブルをシャードしたので、テーブルは自動的にコロケーションされます。つまり、両方のテーブルの1つのuser_idに関連するすべてのデータが同じワーカーノード上にあります。これは、コロケーションされたシャード全体で、ワーカーノード上での２つのテーブル間の結合をローカルに実行する場合に役立ちます。コロケーションの詳細は次の「マルチテナントアプリケーション」で説明します。

<IMG>

> 注: Hyperscale (Citus) サーバー内には、3種類のテーブルがあります。
>	- 分散テーブル – ワーカーノードを跨いで分散（スケールアウト）。一般的に大きなテーブルはパフォーマンスを改善するために分散したテーブルであるべきです。
>	- 参照テーブル – 全てのノードに複製されます。分散テーブルとの結合を可能にします。典型的には国や製品カテゴリのような小さなテーブルに用いられます。
>	- ローカルテーブル – コーディネーターノードに置かれるテーブルで、シャーディングのメタデータの管理テーブルが典型例です。

